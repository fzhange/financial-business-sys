## ADDED Requirements

### Requirement: 应付与实付核销
系统 SHALL 支持应付账款与实际付款的核销对账，确保账目清晰准确。

#### Scenario: 自动核销
- **GIVEN** 付款单状态变更为"已完成"
- **WHEN** 系统处理付款完成
- **THEN** 自动创建核销记录，核销类型为"自动核销"，核销金额等于付款金额

#### Scenario: 手工核销
- **GIVEN** 存在未核销的付款和应付账款
- **WHEN** 用户手动发起核销操作，指定核销金额
- **THEN** 系统创建核销记录，核销类型为"手工核销"

### Requirement: 核销金额校验
系统 SHALL 校验核销金额的合理性。

#### Scenario: 核销金额不超过未付金额
- **GIVEN** 用户发起核销操作
- **WHEN** 核销金额超过应付账款的未付金额
- **THEN** 系统拒绝操作并提示"核销金额不能超过未付金额"

#### Scenario: 核销金额不超过付款金额
- **GIVEN** 用户发起核销操作
- **WHEN** 核销金额超过付款单的可核销金额
- **THEN** 系统拒绝操作并提示"核销金额不能超过付款金额"

### Requirement: 核销状态更新
系统 SHALL 在核销完成后更新相关单据状态。

#### Scenario: 核销后更新应付账款
- **GIVEN** 核销记录创建成功
- **WHEN** 系统处理核销
- **THEN** 更新应付账款的已付金额，若全部核销则状态变更为"已核销"

#### Scenario: 部分核销
- **GIVEN** 应付账款金额大于本次核销金额
- **WHEN** 核销完成
- **THEN** 应付账款状态保持"部分付款"，未付金额相应减少

### Requirement: 核销冲销
系统 SHALL 支持对错误的核销记录进行冲销操作。

#### Scenario: 冲销核销记录
- **GIVEN** 存在已完成的核销记录
- **WHEN** 用户发起冲销操作
- **THEN** 系统将核销状态更新为"已冲销"，恢复应付账款的未付金额

#### Scenario: 冲销后状态恢复
- **GIVEN** 核销记录被冲销
- **WHEN** 系统处理冲销
- **THEN** 应付账款的已付金额减少，状态根据当前金额重新计算

### Requirement: 核销记录查看
系统 SHALL 提供核销记录列表页面。

#### Scenario: 查看核销记录列表
- **GIVEN** 存在多条核销记录
- **WHEN** 用户访问核销管理页面
- **THEN** 系统显示所有核销记录，包括核销金额、类型、状态等

#### Scenario: 按应付账款查看核销
- **GIVEN** 用户查看某条应付账款详情
- **WHEN** 该应付账款存在核销记录
- **THEN** 系统显示关联的所有核销记录

### Requirement: 核销数据结构
系统 SHALL 按以下结构存储核销记录：
- 核销ID、核销单号
- 关联应付账款ID、关联付款单ID
- 核销金额、核销日期
- 核销类型（自动核销/手工核销）
- 状态（已完成/已冲销）
- 备注、创建时间、更新时间

#### Scenario: 核销记录追溯
- **GIVEN** 用户查看核销记录
- **WHEN** 点击关联单据
- **THEN** 系统支持跳转到关联的应付账款和付款单详情
