## ADDED Requirements

### Requirement: 付款单生成
系统 SHALL 在付款完成后自动生成付款单记录。

#### Scenario: 从请款单发起付款
- **GIVEN** 请款单状态为"已审批"且未付金额 > 0
- **WHEN** 用户在请款单详情页点击"发起付款"
- **THEN** 系统弹出付款对话框，显示可付金额范围（0 ~ 未付金额）

#### Scenario: 填写付款信息
- **GIVEN** 付款对话框已打开
- **WHEN** 用户填写付款金额、付款方式、收款账号、收款银行、交易流水号
- **THEN** 系统校验付款信息完整性

#### Scenario: 付款金额校验
- **GIVEN** 用户输入付款金额
- **WHEN** 付款金额 > 请款单未付金额
- **THEN** 系统拒绝并提示"付款金额不能超过未付金额 XXX 元"

#### Scenario: 执行付款并生成付款单
- **GIVEN** 用户已填写完整付款信息，付款金额 ≤ 请款单未付金额
- **WHEN** 用户点击"确认付款"
- **THEN** 系统执行以下操作：
  1. 生成付款单，状态为"已完成"
  2. 更新请款单已付金额
  3. 若请款单全部付清，状态变为"已付款"
  4. 更新应付账款的已付金额

### Requirement: 付款无需审批
系统 SHALL 支持已审批请款单直接付款，无需再次审批。

#### Scenario: 付款无审批流程
- **GIVEN** 请款单已审批
- **WHEN** 用户执行付款
- **THEN** 付款完成后直接生成"已完成"状态的付款单，无中间审批环节

### Requirement: 付款更新应付账款
系统 SHALL 在付款完成后自动更新应付账款金额。

#### Scenario: 付款后更新应付账款
- **GIVEN** 付款执行成功
- **WHEN** 系统生成付款单
- **THEN** 自动更新关联应付账款的已付金额，重新计算未付金额和付款状态

#### Scenario: 更新请款单已付金额
- **GIVEN** 付款执行成功
- **WHEN** 系统生成付款单
- **THEN** 关联请款单的已付金额增加，若全部付清则状态变为"已付款"

### Requirement: 付款单列表管理
系统 SHALL 提供付款单列表页面。

#### Scenario: 查看付款单列表
- **GIVEN** 存在多条付款单
- **WHEN** 用户访问付款单列表页面
- **THEN** 系统显示所有付款单，包括付款金额、付款方式、状态、关联请款单等信息

#### Scenario: 按状态筛选付款单
- **GIVEN** 付款单列表页面
- **WHEN** 用户选择状态筛选
- **THEN** 系统显示符合条件的付款单

### Requirement: 付款单数据结构
系统 SHALL 按以下结构存储付款单数据：
- 付款单ID、付款单号
- 关联请款单ID、关联应付账款ID
- 供应商ID、供应商名称
- 付款金额
- 付款方式（银行转账/支票/现金/其他）
- 收款账号、收款银行
- 付款日期
- 状态（已完成/付款失败）
- 已核销金额、未核销金额
- 核销状态（未核销/部分核销/已核销）
- 完成时间、交易流水号
- 备注、创建时间、更新时间

#### Scenario: 付款单状态说明
- **GIVEN** 付款单生成机制
- **WHEN** 付款完成后生成付款单
- **THEN** 付款单状态为"已完成"，付款失败时状态为"付款失败"

#### Scenario: 付款单核销状态说明
- **GIVEN** 付款单已完成
- **WHEN** 三单匹配核销时使用该付款单
- **THEN** 系统更新付款单的核销金额和核销状态：
  - 未核销金额 = 付款金额 - 已核销金额
  - 核销状态根据已核销金额判断：
    - 已核销金额 = 0 → 未核销
    - 0 < 已核销金额 < 付款金额 → 部分核销
    - 已核销金额 = 付款金额 → 已核销
