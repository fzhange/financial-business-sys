## ADDED Requirements

### Requirement: 供应商对账单生成
系统 SHALL 支持基于账期内的采购入库单和退货单自动生成供应商对账单。

#### Scenario: 按账期生成对账单
- **GIVEN** 用户选择供应商和账期范围（开始日期、结束日期）
- **WHEN** 用户点击"生成对账单"
- **THEN** 系统汇总该账期内该供应商所有已确认的入库和退货记录，生成对账单草稿

#### Scenario: 对账单金额计算
- **GIVEN** 账期内存在入库记录和退货记录
- **WHEN** 生成对账单时
- **THEN** 系统计算：入库总额、退货总额、净额（入库总额-退货总额）

### Requirement: 双方对账核对
系统 SHALL 支持企业与供应商双方核对对账单，确保数据一致。

#### Scenario: 录入供应商对账金额
- **GIVEN** 对账单已生成
- **WHEN** 用户录入供应商提供的对账金额
- **THEN** 系统自动计算差异金额（企业净额 - 供应商金额）

#### Scenario: 发现对账差异
- **GIVEN** 对账单差异金额不为零
- **WHEN** 用户查看对账详情
- **THEN** 系统显示差异金额和差异明细，并允许用户标记为"有争议"状态进行沟通

#### Scenario: 差异归责与修正-供应商问题
- **GIVEN** 对账单状态为"有争议"，差异原因为供应商数据错误
- **WHEN** 沟通确认后由供应商修正其对账单
- **THEN** 供应商提供修正后的对账金额，系统更新供应商对账金额并重新计算差异

#### Scenario: 差异归责与修正-采购方问题
- **GIVEN** 对账单状态为"有争议"，差异原因为采购方收货/退货记录错误
- **WHEN** 沟通确认后采购方修正收货/退货记录
- **THEN** 系统重新汇总该对账单关联的采购记录，更新入库总额/退货总额/净额，重新计算差异

#### Scenario: 修正后重新核对
- **GIVEN** 任一方完成数据修正
- **WHEN** 重新核对差异
- **THEN** 若差异为零，可继续确认流程；若差异不为零，需继续修正直至差异为零

#### Scenario: 差异不为零不能确认
- **GIVEN** 对账单差异金额不为零
- **WHEN** 尝试进入确认流程
- **THEN** 系统阻止操作并提示"对账差异不为零，请先解决差异"

### Requirement: 对账单确认
系统 SHALL 支持对账单的顺序确认操作，供应商先确认，采购方后确认，双方都确认后生成应付账款。

#### Scenario: 供应商确认对账单
- **GIVEN** 对账单差异为零，状态为"待供应商确认"
- **WHEN** 供应商确认对账结果
- **THEN** 系统记录供应商已确认，对账单状态更新为"待采购方确认"

#### Scenario: 采购方确认对账单
- **GIVEN** 对账单供应商已确认，差异为零，状态为"待采购方确认"
- **WHEN** 采购方确认对账结果
- **THEN** 系统记录采购方已确认，对账单状态更新为"已确认"，自动生成对应的应付账款记录

#### Scenario: 采购方不能先于供应商确认
- **GIVEN** 对账单状态为"待供应商确认"
- **WHEN** 采购方尝试确认对账单
- **THEN** 系统阻止操作并提示"请等待供应商先确认"

#### Scenario: 已确认对账单不可修改
- **GIVEN** 对账单状态为"已确认"
- **WHEN** 用户尝试修改对账单
- **THEN** 系统拒绝修改操作并提示"已确认的对账单不可修改"

### Requirement: 供应商对账单数据结构
系统 SHALL 按以下结构存储对账单数据：
- 对账单ID、对账单号
- 供应商ID、供应商名称
- 账期开始日期、账期结束日期
- 关联的采购记录ID列表
- 入库总额、退货总额、净额
- 供应商对账金额、差异金额
- 供应商确认状态、供应商确认时间
- 采购方确认状态、采购方确认时间、采购方确认人
- 状态（草稿/待供应商确认/有争议/待采购方确认/已确认）
- 备注
- 创建时间、更新时间

#### Scenario: 对账单状态流转
- **GIVEN** 新建的对账单
- **WHEN** 对账单经历完整流程
- **THEN** 状态依次流转：草稿 -> 待供应商确认 -> (有争议 ->) 待采购方确认 -> 已确认
