## ADDED Requirements

### Requirement: 应付账款自动生成
系统 SHALL 在对账单确认后自动生成应付账款记录。

#### Scenario: 对账确认后生成应付账款
- **GIVEN** 对账单状态变更为"已确认"
- **WHEN** 系统处理确认操作
- **THEN** 自动创建应付账款记录，应付金额等于对账单净额，付款状态为"未付款"，核销状态为"未核销"

#### Scenario: 应付账款关联对账单
- **GIVEN** 应付账款由对账单生成
- **WHEN** 查看应付账款详情
- **THEN** 显示关联的对账单信息，支持跳转查看原对账单

### Requirement: 应付账款列表查看
系统 SHALL 提供应付账款列表页面，支持查看和筛选。

#### Scenario: 查看应付账款列表
- **GIVEN** 存在多条应付账款记录
- **WHEN** 用户访问应付账款列表页面
- **THEN** 系统显示所有应付账款，包括应付金额、已付金额、未付金额、已开票金额、已核销金额、未核销金额、付款状态、核销状态等信息

#### Scenario: 按付款状态筛选应付账款
- **GIVEN** 应付账款列表页面
- **WHEN** 用户选择付款状态筛选条件（未付款/部分付款/已付款）
- **THEN** 系统显示符合条件的应付账款记录

#### Scenario: 按核销状态筛选应付账款
- **GIVEN** 应付账款列表页面
- **WHEN** 用户选择核销状态筛选条件（未核销/部分核销/已核销）
- **THEN** 系统显示符合条件的应付账款记录

### Requirement: 应付账款付款状态管理
系统 SHALL 根据付款情况自动更新应付账款付款状态。

#### Scenario: 部分付款状态
- **GIVEN** 应付账款已付金额大于0但小于应付金额
- **WHEN** 系统更新应付账款状态
- **THEN** 付款状态变更为"部分付款"

#### Scenario: 完全付款状态
- **GIVEN** 应付账款已付金额等于应付金额
- **WHEN** 系统更新应付账款状态
- **THEN** 付款状态变更为"已付款"

### Requirement: 应付账款核销状态管理（三单匹配）
系统 SHALL 根据核销情况自动更新应付账款核销状态。

#### Scenario: 部分核销状态
- **GIVEN** 应付账款已核销金额大于0但小于应付金额
- **WHEN** 财务人员完成一次核销操作
- **THEN** 核销状态变更为"部分核销"

#### Scenario: 完全核销状态
- **GIVEN** 应付账款已核销金额等于应付金额
- **WHEN** 财务人员完成最后一次核销操作
- **THEN** 核销状态变更为"已核销"

### Requirement: 三单匹配核销
系统 SHALL 支持应付账款、付款单、发票的三单匹配手动核销。

#### Scenario: 发起核销操作
- **GIVEN** 应付账款存在未核销的付款金额
- **AND** 该应付账款存在未核销的发票金额
- **WHEN** 财务人员选择付款单、发票，输入核销金额
- **THEN** 系统校验核销金额是否合法，合法则创建核销记录

#### Scenario: 核销金额校验
- **GIVEN** 财务人员发起核销操作
- **WHEN** 输入核销金额
- **THEN** 核销金额 ≤ min(该应付账款未核销付款金额, 该应付账款未核销发票金额)

#### Scenario: 多次部分核销
- **GIVEN** 应付账款金额为10万，已核销6万
- **WHEN** 财务人员再次发起核销操作，核销金额为4万
- **THEN** 系统创建核销记录，应付账款核销状态变更为"已核销"

#### Scenario: 核销时机灵活
- **GIVEN** 应付账款已付款6万，已开票4万
- **WHEN** 财务人员发起核销
- **THEN** 可核销金额最大为4万（取已付款和已开票金额的较小值中未核销部分）

### Requirement: 应付账款数据结构
系统 SHALL 按以下结构存储应付账款数据：
- 应付账款ID、应付单号
- 关联对账单ID
- 供应商ID、供应商名称
- 应付金额
- 已付金额、未付金额
- 已开票金额
- 已核销金额、未核销金额
- 付款状态（未付款/部分付款/已付款）
- 核销状态（未核销/部分核销/已核销）
- 到期日
- 创建时间、更新时间

#### Scenario: 应付账款金额计算
- **GIVEN** 应付账款发生付款或核销
- **WHEN** 系统更新应付账款
- **THEN** 自动计算：
  - 未付金额 = 应付金额 - 已付金额
  - 未核销金额 = 应付金额 - 已核销金额

### Requirement: 核销记录数据结构
系统 SHALL 按以下结构存储核销记录数据：
- 核销记录ID、核销单号
- 关联应付账款ID、付款单ID、发票ID
- 核销金额
- 核销日期、核销人、核销时间
- 状态（已完成/已冲销）
- 冲销相关：冲销时间、冲销人、冲销原因类型、冲销原因详情
- 创建时间、更新时间

### Requirement: 应付账款核销记录查看
系统 SHALL 在应付账款详情中显示该笔应付的所有核销记录。

#### Scenario: 查看应付账款核销记录
- **GIVEN** 应付账款存在核销记录
- **WHEN** 用户查看应付账款详情
- **THEN** 显示该应付账款的核销记录列表，包括核销单号、付款单、发票、核销金额、核销状态等

### Requirement: 核销冲销
系统 SHALL 支持对已完成的核销记录进行冲销操作。

#### Scenario: 发起冲销操作
- **GIVEN** 核销记录状态为"已完成"
- **WHEN** 财务主管选择冲销并填写原因
- **THEN** 系统将核销记录状态更新为"已冲销"，并恢复应付账款、付款单、发票的未核销金额

#### Scenario: 冲销原因必填
- **GIVEN** 用户发起冲销操作
- **WHEN** 选择冲销原因类型（录入错误/业务变更/重复核销/发票退回/其他）
- **THEN** 必须填写详细说明（至少10个字符）

#### Scenario: 跨月核销冲销
- **GIVEN** 核销记录为跨月核销
- **WHEN** 发起冲销
- **THEN** 需提交审批后方可执行
