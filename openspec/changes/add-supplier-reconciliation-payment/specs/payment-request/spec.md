## ADDED Requirements

### Requirement: 请款单创建
系统 SHALL 支持基于已校验发票创建请款申请。

#### Scenario: 创建请款单
- **GIVEN** 用户在请款管理页面
- **WHEN** 用户选择应付账款和已校验的发票，填写请款金额和事由
- **THEN** 系统创建请款单，状态为"草稿"

#### Scenario: 请款金额校验
- **GIVEN** 用户创建请款单
- **WHEN** 请款金额超过关联发票的价税合计
- **THEN** 系统拒绝创建并提示"请款金额不能超过发票金额"

#### Scenario: 请款必须关联发票
- **GIVEN** 用户尝试创建请款单
- **WHEN** 未选择任何已校验发票
- **THEN** 系统拒绝创建并提示"请款必须关联至少一张已校验发票"

### Requirement: 请款单提交
系统 SHALL 支持提交请款单进入审批流程。

#### Scenario: 提交请款单
- **GIVEN** 请款单状态为"草稿"
- **WHEN** 用户提交请款单
- **THEN** 系统将状态更新为"待审批"，记录提交时间和提交人

#### Scenario: 已提交请款单不可修改
- **GIVEN** 请款单状态为"待审批"或更后状态
- **WHEN** 用户尝试修改请款单
- **THEN** 系统拒绝修改操作

### Requirement: 请款单审批
系统 SHALL 支持财务人员审核请款申请。

#### Scenario: 审批通过请款单
- **GIVEN** 请款单状态为"待审批"
- **WHEN** 财务审核人员审批通过
- **THEN** 系统将状态更新为"已审批"，记录审批时间、审批人，该请款单可进行付款

#### Scenario: 审批拒绝请款单
- **GIVEN** 请款单状态为"待审批"
- **WHEN** 财务审核人员审批拒绝
- **THEN** 系统将状态更新为"已拒绝"，记录拒绝原因

### Requirement: 请款单列表管理
系统 SHALL 提供请款单列表页面，支持不同角色查看和操作。

#### Scenario: 查看请款单列表
- **GIVEN** 存在多条请款单
- **WHEN** 用户访问请款管理页面
- **THEN** 系统显示所有请款单，支持按状态、供应商筛选

#### Scenario: 待审批请款单高亮
- **GIVEN** 财务人员查看请款列表
- **WHEN** 存在待审批的请款单
- **THEN** 系统突出显示待审批记录，方便快速处理

### Requirement: 请款单数据结构
系统 SHALL 按以下结构存储请款单数据：
- 请款单ID、请款单号
- 关联应付账款ID
- 关联发票ID列表
- 供应商ID、供应商名称
- 请款金额、请款事由
- 已付金额（paidAmount）
- 未付金额（unpaidAmount = 请款金额 - 已付金额）
- 状态（草稿/待审批/已审批/已拒绝/已付款）
- 提交时间、提交人
- 审批时间、审批人、审批备注
- 创建时间、更新时间

#### Scenario: 请款单状态流转
- **GIVEN** 新建的请款单
- **WHEN** 请款单经历完整流程
- **THEN** 状态依次流转：草稿 -> 待审批 -> 已审批 -> 已付款（或草稿 -> 待审批 -> 已拒绝）

### Requirement: 发起付款
系统 SHALL 在已审批请款单详情页提供"发起付款"功能。

#### Scenario: 发起付款入口
- **GIVEN** 请款单状态为"已审批"且未付金额 > 0
- **WHEN** 用户访问请款单详情页
- **THEN** 系统显示"发起付款"按钮

#### Scenario: 已付清请款单不显示付款入口
- **GIVEN** 请款单状态为"已审批"但未付金额 = 0
- **WHEN** 用户访问请款单详情页
- **THEN** 系统不显示"发起付款"按钮

#### Scenario: 非已审批状态不显示付款入口
- **GIVEN** 请款单状态不是"已审批"（如草稿、待审批、已拒绝、已付款）
- **WHEN** 用户访问请款单详情页
- **THEN** 系统不显示"发起付款"按钮

### Requirement: 部分付款
系统 SHALL 支持对请款单进行分多次付款。

#### Scenario: 部分付款
- **GIVEN** 请款单状态为"已审批"，请款金额为 10000，已付金额为 0
- **WHEN** 用户发起付款，付款金额为 6000
- **THEN** 系统完成付款后，已付金额更新为 6000，未付金额为 4000，请款单状态保持"已审批"

#### Scenario: 完成全部付款
- **GIVEN** 请款单状态为"已审批"，请款金额为 10000，已付金额为 6000
- **WHEN** 用户发起付款，付款金额为 4000
- **THEN** 系统完成付款后，已付金额更新为 10000，未付金额为 0，请款单状态变更为"已付款"

#### Scenario: 付款金额校验
- **GIVEN** 请款单未付金额为 4000
- **WHEN** 用户尝试付款 5000
- **THEN** 系统拒绝付款并提示"付款金额不能超过未付金额"
