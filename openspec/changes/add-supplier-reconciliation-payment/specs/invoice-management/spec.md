## ADDED Requirements

### Requirement: 发票手工录入
系统 SHALL 支持人工手工录入供应商开具的发票信息，并关联到应付账款。

#### Scenario: 手工录入发票信息
- **GIVEN** 用户在发票管理页面选择"手工录入"
- **WHEN** 用户填写发票信息（发票代码、发票号码、发票类型、开票日期、金额、税额、销售方名称、销售方税号等）并选择关联的应付账款
- **THEN** 系统创建发票记录，录入方式标记为"手工录入"，状态为"待校验"

#### Scenario: 发票关联应付账款（多对多）
- **GIVEN** 存在未付款或部分付款的应付账款
- **WHEN** 用户创建或编辑发票时
- **THEN** 系统显示可关联的应付账款列表，用户可选择一个或多个应付账款进行关联

#### Scenario: 一张发票关联多个应付账款
- **GIVEN** 供应商开具一张合并发票对应多笔业务
- **WHEN** 用户录入该发票
- **THEN** 系统允许选择多个应付账款关联到同一张发票，并记录每个应付账款对应的发票金额分摊

#### Scenario: 一笔应付账款关联多张发票
- **GIVEN** 供应商分批开票
- **WHEN** 用户为同一应付账款录入多张发票
- **THEN** 系统允许多张发票关联到同一应付账款，累计已开票金额不得超过应付金额

### Requirement: 发票OCR识别
系统 SHALL 支持通过OCR技术自动识别纸质或电子发票内容，减少人工录入错误。

#### Scenario: 上传发票图片进行OCR识别
- **GIVEN** 用户在发票管理页面选择"OCR识别"
- **WHEN** 用户上传发票扫描件或拍照图片（支持JPG、PNG格式）
- **THEN** 系统调用OCR服务识别发票内容，自动填充发票代码、号码、开票日期、金额、税额、销售方信息等字段

#### Scenario: OCR识别结果确认
- **GIVEN** OCR识别完成
- **WHEN** 系统展示识别结果
- **THEN** 用户查看识别结果，若信息正确则确认创建发票记录，录入方式标记为"OCR识别"

#### Scenario: OCR识别结果有误-重新识别
- **GIVEN** OCR识别结果与实际发票信息不符
- **WHEN** 用户发现识别错误
- **THEN** 用户可选择"重新上传"清晰图片进行重新识别，系统不允许人工修改OCR识别结果（防止人为改错）

#### Scenario: OCR识别失败
- **GIVEN** 用户上传发票图片
- **WHEN** 图片质量差或格式不支持导致识别失败
- **THEN** 系统提示"识别失败，请检查图片质量或改用手工录入"

### Requirement: 电子发票导入
系统 SHALL 支持批量导入PDF、OFD、XML等格式的电子发票文件。

#### Scenario: 导入PDF格式电子发票
- **GIVEN** 用户在发票管理页面选择"电子发票导入"
- **WHEN** 用户上传PDF格式的电子发票文件
- **THEN** 系统解析PDF文件提取发票信息，自动创建发票记录，录入方式标记为"电子发票导入"

#### Scenario: 导入OFD格式电子发票
- **GIVEN** 用户选择"电子发票导入"
- **WHEN** 用户上传OFD格式的电子发票文件
- **THEN** 系统解析OFD文件提取发票结构化数据，自动创建发票记录

#### Scenario: 导入XML格式电子发票
- **GIVEN** 用户选择"电子发票导入"
- **WHEN** 用户上传XML格式的电子发票数据文件
- **THEN** 系统解析XML文件提取发票信息，自动创建发票记录

#### Scenario: 批量导入电子发票
- **GIVEN** 用户有多张电子发票需要导入
- **WHEN** 用户选择多个电子发票文件（或ZIP压缩包）进行批量上传
- **THEN** 系统依次解析并创建发票记录，显示导入结果（成功数、失败数及失败原因）

#### Scenario: 电子发票解析失败
- **GIVEN** 用户上传电子发票文件
- **WHEN** 文件格式损坏或不符合规范
- **THEN** 系统提示具体的解析错误原因，该文件导入失败

### Requirement: 发票真伪校验
系统 SHALL 支持对发票进行真伪验证，确保发票的合法性。

#### Scenario: 发票真伪在线验证
- **GIVEN** 发票记录已创建，状态为"待校验"
- **WHEN** 用户点击"真伪校验"或系统自动触发校验
- **THEN** 系统调用税务局发票查验接口，验证发票代码、号码、开票日期、金额等信息的真实性

#### Scenario: 真伪校验通过-可用
- **GIVEN** 系统完成真伪校验
- **WHEN** 校验结果为真票且信息一致
- **THEN** 系统标记发票为"可用"状态，真伪状态为"已验真"，记录校验时间

#### Scenario: 真伪校验失败-不可用
- **GIVEN** 系统完成真伪校验
- **WHEN** 校验结果显示发票不存在或为假票
- **THEN** 系统标记发票为"不可用"状态，真伪状态为"验证失败"，记录不可用原因"发票真伪校验未通过：[具体原因]"

#### Scenario: 真伪校验失败-信息不符
- **GIVEN** 系统完成真伪校验
- **WHEN** 发票存在但金额、日期等信息与录入不一致
- **THEN** 系统标记发票为"不可用"状态，记录不可用原因"信息不符：[差异明细]"，用户需重新录入正确信息

#### Scenario: 不可用发票不能用于请款
- **GIVEN** 发票状态为"不可用"
- **WHEN** 用户尝试将该发票关联到请款单
- **THEN** 系统阻止操作并提示"该发票不可用，原因：[不可用原因]"

#### Scenario: 真伪校验服务不可用
- **GIVEN** 用户发起真伪校验
- **WHEN** 税务局查验接口不可用
- **THEN** 系统提示"校验服务暂不可用，请稍后重试"，发票真伪状态保持"待验证"

### Requirement: 发票重复校验
系统 SHALL 在发票录入时自动检测重复发票，防止同一张发票重复入账。

#### Scenario: 录入时检测重复发票
- **GIVEN** 用户正在录入或导入发票
- **WHEN** 系统检测到已存在相同发票代码+发票号码的记录
- **THEN** 系统阻止录入并提示"发票重复，该发票已于[日期]录入，单号[XXX]"

#### Scenario: 跨供应商重复检测
- **GIVEN** 用户录入发票
- **WHEN** 发票代码+号码相同但供应商不同
- **THEN** 系统仍判定为重复发票并阻止录入（同一张发票不能关联不同供应商）

#### Scenario: 批量导入时重复处理
- **GIVEN** 用户批量导入电子发票
- **WHEN** 部分发票与系统已有记录重复
- **THEN** 系统跳过重复发票，继续导入其他发票，最终显示"成功X张，重复跳过Y张"

### Requirement: 发票业务校验
系统 SHALL 支持对发票进行业务层面的校验确认，更新可用状态。

#### Scenario: 业务校验通过-可用
- **GIVEN** 发票真伪已验证通过
- **WHEN** 采购方完成业务校验（核对发票内容与采购业务一致）并确认无误
- **THEN** 系统标记发票为"可用"状态，该发票可用于请款

#### Scenario: 业务校验不通过-不可用
- **GIVEN** 发票录入后
- **WHEN** 发现发票内容与业务不符
- **THEN** 系统标记发票为"不可用"状态，记录不可用原因

#### Scenario: 关联应付账款时金额校验
- **GIVEN** 用户将发票关联到应付账款
- **WHEN** 该发票的分摊金额超过应付账款的剩余未开票金额
- **THEN** 系统阻止关联并提示"发票分摊金额不能超过应付账款余额"

#### Scenario: 发票录入无金额限制
- **GIVEN** 用户录入发票
- **WHEN** 输入发票金额
- **THEN** 系统不校验金额大小，仅校验格式正确性

### Requirement: 发票列表管理
系统 SHALL 提供发票列表页面，支持查看和管理发票。

#### Scenario: 查看发票列表
- **GIVEN** 存在多条发票记录
- **WHEN** 用户访问发票管理页面
- **THEN** 系统显示所有发票，支持按可用状态、供应商、日期、录入方式筛选

#### Scenario: 删除不可用发票
- **GIVEN** 发票状态为"不可用"且未关联请款单
- **WHEN** 用户删除发票
- **THEN** 系统删除该发票记录

### Requirement: 发票数据结构
系统 SHALL 按以下结构存储发票数据：
- 发票ID、发票号码、发票代码
- 发票类型（增值税专用发票/增值税普通发票/其他）
- 供应商ID、供应商名称
- 销售方名称、销售方税号
- 金额（不含税）、税额、价税合计
- 开票日期、收票日期
- 录入方式（手工录入/OCR识别/电子发票导入）
- 原始文件路径（OCR图片或电子发票文件）
- 真伪校验状态（待验证/已验真/验证失败）、真伪校验时间
- 可用状态（可用/不可用）、不可用原因
- 校验时间、校验人、备注
- 创建时间、更新时间

系统 SHALL 通过关联表存储发票与应付账款的多对多关系：
- 关联ID、发票ID、应付账款ID
- 分摊金额（该发票对应该应付的金额）
- 创建时间

#### Scenario: 发票金额计算
- **GIVEN** 用户录入发票金额和税额
- **WHEN** 保存发票时
- **THEN** 系统自动计算：价税合计 = 金额 + 税额
